---
title: Using ecmwfr to measure global warming
author: 'Elio Campitelli'
date: '2019-04-19'
slug: ecmwfr-global-warming
categories: [R]
tags: [ejemplos, paquetes]
---



<p>For my research I needed to download gridded weather data from ERA-Interim, which is a big dataset generated by the <a href="https://www.ecmwf.int/">ECMWF</a>. Getting long term data through their website is <strong>very</strong> time consuming and requires <strong>a lot</strong> of clicks. Thankfuly, I came accross the nifty <a href="https://github.com/khufkens/ecmwfr">ecmwfr</a> R package that allowed me to do it with ease. One of the great things about open source is that users can also be collaborators, so I made a few suggestions and offered some code.</p>
<p>Now that a new version is on it‚Äôs way to CRAN, I wanted to show a quick example of what you can do with the package.</p>
<p>To download data from the ECMWF servers you need to have an account. So if you‚Äôre following at home, you‚Äôll need create one and add the API key to the ecmwfr keyring. This is all done interactivelly with this command:</p>
<pre class="r"><code>library(ecmwfr)

wf_set_key(service = &quot;webapi&quot;)</code></pre>
<p>This will take you to the correct URL where you can get your key, and then sorts everything out to use it.</p>
<p>Now, in order to get data from the ECMWF servers I need to have a valid request. Unfortunatelly, since it hosts a huge number of different datasets with different data streams and time resolution, building a valid request from scratch is rather complicated. The easiest way to work with it is going to their <a href="https://apps.ecmwf.int/datasets/">to the website</a> and use their point and click interface to create a basic request for the dataset of interest. In my case, I will use monthly data from <a href="https://apps.ecmwf.int/datasets/data/interim-full-daily/levtype=sfc/">ERA Interim</a>.</p>
<div class="figure">
<img src="/post/2019-04-19-como-cambio-el-tiempo-desde-que-naci_files/webapi-erainterim.png" alt="ERA Interim request" />
<p class="caption">ERA Interim request</p>
</div>
<p>As you can see, there‚Äôs no way of retreiving every year in one request using the web interface. But a the bottom of the page there‚Äôs a link that says ‚ÄúView the MARS request‚Äù.</p>
<div class="figure">
<img src="/post/2019-04-19-como-cambio-el-tiempo-desde-que-naci_files/webapi-erainterim2.png" alt="ERA Interim MARS" />
<p class="caption">ERA Interim MARS</p>
</div>
<p>Here, I get a valid request that I can modify slightly. In R, I converted this template into a list using the ‚ÄúMARS to list‚Äù RStudio addin (but you can do it manually). I added <code>format  = &quot;netcdf&quot;</code> at the end to get the data as a NetCDF file.</p>
<p>I then pass that list to the <code>wf_archetype()</code> function.</p>
<pre class="r"><code>ERAI_monthly &lt;- wf_archetype(
   request = list(
      class   = &quot;ei&quot;,
      dataset = &quot;interim&quot;,
      date    = &quot;19790101/19790201/19790301/19790401/19790501/19790601/19790701/19790801/19790901/19791001/19791101/19791201&quot;,
      expver  = &quot;1&quot;,
      grid    = &quot;0.75/0.75&quot;,
      levtype = &quot;sfc&quot;,
      param   = &quot;167.128&quot;,
      stream  = &quot;moda&quot;,
      type    = &quot;an&quot;,
      target  = &quot;output&quot;,
      format  = &quot;netcdf&quot;),
   dynamic_fields = c(&quot;date&quot;, &quot;grid&quot;, &quot;target&quot;))</code></pre>
<p>Now <code>ERAI_montly</code> is a function with arguments ‚Äúdate‚Äù, ‚Äúgrid‚Äù and ‚Äútarget‚Äù. The reason I don‚Äôt just change the list willi nilli is that I want to be sure to always get a valid request pointing to the ERA Interim dataset. For this short example is probably overkill, but it‚Äôs usefull in a bigger project with multiple data requests.</p>
<p>As you can see, the MARS format for dates can be rather long to type, so I‚Äôll create a custom function to make this easier:</p>
<pre class="r"><code>format_dates &lt;- function(dates) {
   dates &lt;- as.Date(dates)
   paste0(lubridate::year(dates),
          formatC(lubridate::month(dates), width = 2, flag = &quot;0&quot;),
          formatC(lubridate::day(dates), width = 2, flag = &quot;0&quot;),
          collapse = &quot;/&quot;)
}

format_dates(c(&quot;2018-01-01&quot;, &quot;2018-02-01&quot;))</code></pre>
<pre><code>## [1] &quot;20180101/20180201&quot;</code></pre>
<p>Now I‚Äôm ready to downlaod data! I was bown in august 1988, so I will be looking at how the month of august changed since that year. I‚Äôm also not terribly interested in local changes, so I‚Äôll use a 3¬∞ by 3¬∞ resolution.</p>
<pre class="r"><code>dates &lt;- seq.Date(as.Date(&quot;1988-08-01&quot;), as.Date(&quot;2018-08-01&quot;), &quot;1 year&quot;)

my_request &lt;- ERAI_monthly(date = format_dates(dates), 
                           grid = &quot;3/3&quot;,
                           target = &quot;august_monthly.nc&quot;)
str(my_request)</code></pre>
<pre><code>## List of 11
##  $ class  : chr &quot;ei&quot;
##  $ dataset: chr &quot;interim&quot;
##  $ date   : chr &quot;19880801/19890801/19900801/19910801/19920801/19930801/19940801/19950801/19960801/19970801/19980801/19990801/200&quot;| __truncated__
##  $ expver : chr &quot;1&quot;
##  $ grid   : chr &quot;3/3&quot;
##  $ levtype: chr &quot;sfc&quot;
##  $ param  : chr &quot;167.128&quot;
##  $ stream : chr &quot;moda&quot;
##  $ type   : chr &quot;an&quot;
##  $ target : chr &quot;august_monthly.nc&quot;
##  $ format : chr &quot;netcdf&quot;</code></pre>
<p>And now, <code>wf_request()</code> to download the data. This will take some. Not because I‚Äôm downloading a huge file (is not, about 455kb) but because the ECMWF has to process the request and collect the data. So if you‚Äôre following at home, you can go make some tea or, if you‚Äôre like me, mate. üçµ</p>
<pre class="r"><code>wf_request(request = my_request,
           user = &quot;eliocampitelli@gmail.com&quot;, 
           transfer = TRUE,
           path = &quot;data&quot;, 
           verbose = FALSE)</code></pre>
<p>Now that I have my data saved as ‚Äúaugust_monthly.nc‚Äù, I‚Äôll just need to load it and analyse it. I‚Äôll be using my <a href="https://eliocamp.github.io/metR/">metR</a> package for that.</p>
<pre class="r"><code>library(metR)
library(ggplot2)
library(data.table)</code></pre>
<pre class="r"><code>august_temp &lt;- ReadNetCDF(&quot;data/august_monthly.nc&quot;)</code></pre>
<p>First a quick look at the data.</p>
<pre class="r"><code>str(august_temp)</code></pre>
<pre><code>## Classes &#39;data.table&#39; and &#39;data.frame&#39;:   226920 obs. of  4 variables:
##  $ longitude: int  0 3 6 9 12 15 18 21 24 27 ...
##  $ latitude : int  90 90 90 90 90 90 90 90 90 90 ...
##  $ t2m      : num  273 273 273 273 273 ...
##  $ time     : POSIXct, format: &quot;1988-08-01&quot; &quot;1988-08-01&quot; ...
##  - attr(*, &quot;.internal.selfref&quot;)=&lt;externalptr&gt;</code></pre>
<p>It‚Äôs a data frame with a value of <code>t2m</code> for each longitude, latitude and time. The temperature is in Kelvin. Let‚Äôs take a look at one field.</p>
<pre class="r"><code># world map
world &lt;- list(geom_path(data = map_data(&quot;world2&quot;), 
                        aes(long, lat, group = group), 
                        size = 0.2, color = &quot;gray50&quot;),
              coord_quickmap(),
              scale_x_longitude(),
              scale_y_latitude())

ggplot(august_temp[time == time[1]], aes(longitude, latitude)) +
   geom_contour_fill(aes(z = t2m - 273.15)) +
   world +
   scale_fill_divergent(&quot;2m temperature (¬∞C)&quot;) +
   metR:::theme_field()</code></pre>
<p><img src="/post/2019-04-19-como-cambio-el-tiempo-desde-que-naci.en_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>The tropis are warmer than the poles, as it should be.</p>
<p>After getting to know the data, I‚Äôll compute the linear trend of temperature at each gridpoint. I‚Äôll use a <strong>very crude</strong> method to get the statistical signficance of the trend.</p>
<pre class="r"><code>trends &lt;- august_temp[, FitLm(year = year(time), t2m, se = TRUE), 
                      by = .(longitude, latitude)] 
trends[, p.value :=  pt(abs(estimate)/std.error, df, lower.tail = FALSE)]

ggplot(trends[term == &quot;year&quot;], aes(longitude, latitude)) +
   geom_contour_fill(aes(z = estimate*10), 
                     breaks = AnchorBreaks(0, 0.25, exclude = 0)) +
   stat_subset(aes(subset = p.value &lt;= 0.01), 
               geom = &quot;point&quot;, size = 0.1, alpha = 0.5) +
   world +
   scale_fill_divergent(&quot;2m temperature \ntrend (¬∞C/decade)&quot;) +
   metR:::theme_field() +
   labs(subtitle = &quot;August mean temperature change 1988-2018&quot;, 
        caption = &quot;Data: ERA Interim&quot;)</code></pre>
<p><img src="/post/2019-04-19-como-cambio-el-tiempo-desde-que-naci.en_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>Not surprisingly, the trend is positive almost everywhere, although not everywhere statistically significant (using this <strong>very crude</strong> method). Of note, there hasn‚Äôt been much increase in august mean temperature where I live.</p>
<p>I will construct a (<strong>crude</strong>) global mean august temperature (‚ÄúGMAT‚Äù) timeseries by averaging all gridpoint for each year (weighing by the cosine of latitude).</p>
<pre class="r"><code>gmat &lt;- august_temp[, .(t2m = weighted.mean(t2m, cos(latitude*pi/180))), 
                   by = year(time)]

ggplot(gmat, aes(year, t2m - 273.15)) +
   geom_line() +
   geom_smooth(method = &quot;lm&quot;) +
   scale_y_continuous(&quot;Global august 2m temperature (¬∞C)&quot;) +
   hrbrthemes::theme_ipsum_rc()</code></pre>
<p><img src="/post/2019-04-19-como-cambio-el-tiempo-desde-que-naci.en_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>Again, not surprisingly, global temperature is going up. Let‚Äôs compute the rate of increase</p>
<pre class="r"><code>trend &lt;- lm(t2m ~ I(year/10), data = gmat)
summary(trend)</code></pre>
<pre><code>## 
## Call:
## lm(formula = t2m ~ I(year/10), data = gmat)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -0.28121 -0.05954 -0.01535  0.06890  0.28129 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 255.78307    4.71318  54.270  &lt; 2e-16 ***
## I(year/10)    0.16756    0.02353   7.121 7.77e-08 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.1172 on 29 degrees of freedom
## Multiple R-squared:  0.6362, Adjusted R-squared:  0.6236 
## F-statistic: 50.71 on 1 and 29 DF,  p-value: 7.772e-08</code></pre>
<p>The rate of 1.68 ¬∞C/decade is consistent with <a href="https://www.ipcc.ch/site/assets/uploads/2018/02/AR5_SYR_FINAL_SPM.pdf">estimates using better methods</a>. üî•</p>
